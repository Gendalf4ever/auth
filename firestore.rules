rules_version = '2';

// Правила безопасности для Firestore Database проекта codent-education
service cloud.firestore {
  match /databases/{database}/documents {
    
    // === ФУНКЦИИ ПОМОЩНИКИ ===
    
    // Проверка аутентификации
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Проверка роли администратора
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Проверка владельца документа
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // === КОЛЛЕКЦИЯ КУРСОВ ===
    match /courses/{courseId} {
      // Чтение курсов доступно всем (публичные курсы)
      allow read: if true;
      
      // Создание и изменение курсов только для администраторов
      allow create, update: if isAdmin();
      
      // Удаление курсов только для администраторов
      allow delete: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ ПОЛЬЗОВАТЕЛЕЙ ===
    match /users/{userId} {
      // Пользователь может читать и изменять только свой профиль
      allow read, write: if isOwner(userId);
      
      // Администраторы могут читать все профили
      allow read: if isAdmin();
      
      // Администраторы могут изменять роли пользователей
      allow update: if isAdmin() && 
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role']);
    }
    
    // === КОЛЛЕКЦИЯ ПРОГРЕССА ОБУЧЕНИЯ ===
    match /user_progress/{userId} {
      // Пользователь может управлять только своим прогрессом
      allow read, write: if isOwner(userId);
      
      // Администраторы могут просматривать весь прогресс
      allow read: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ СЕРТИФИКАТОВ ===
    match /certificates/{certificateId} {
      // Чтение сертификатов доступно всем (для проверки подлинности)
      allow read: if true;
      
      // Создание сертификатов только для администраторов
      allow create: if isAdmin();
      
      // Пользователь может читать только свои сертификаты
      allow read: if isAuthenticated() && 
                  resource.data.userId == request.auth.uid;
    }
    
    // === КОЛЛЕКЦИЯ ОТЗЫВОВ ===
    match /reviews/{reviewId} {
      // Чтение отзывов доступно всем
      allow read: if true;
      
      // Создание отзывов только для аутентифицированных пользователей
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
      
      // Изменение отзыва только автором или администратором
      allow update: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // Удаление отзывов только администраторами
      allow delete: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ УВЕДОМЛЕНИЙ ===
    match /notifications/{notificationId} {
      // Пользователь может управлять только своими уведомлениями
      allow read, write: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid;
      
      // Администраторы могут создавать системные уведомления
      allow create: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ СТАТИСТИКИ ===
    match /statistics/{statId} {
      // Чтение статистики только для администраторов
      allow read: if isAdmin();
      
      // Запись статистики только для системы (через Cloud Functions)
      allow write: if false; // Только через серверные функции
    }
    
    // === КОЛЛЕКЦИЯ НАСТРОЕК СИСТЕМЫ ===
    match /settings/{settingId} {
      // Чтение настроек для всех аутентифицированных пользователей
      allow read: if isAuthenticated();
      
      // Изменение настроек только для администраторов
      allow write: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ ЛОГОВ ===
    match /logs/{logId} {
      // Доступ к логам только для администраторов
      allow read: if isAdmin();
      
      // Запись логов только через серверные функции
      allow write: if false;
    }
    
    // === КОЛЛЕКЦИЯ ВИДЕО ===
    match /videos/{videoId} {
      // Чтение информации о видео доступно всем
      allow read: if true;
      
      // Управление видео только для администраторов
      allow write: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ КАТЕГОРИЙ ===
    match /categories/{categoryId} {
      // Чтение категорий доступно всем
      allow read: if true;
      
      // Управление категориями только для администраторов
      allow write: if isAdmin();
    }
    
    // === КОЛЛЕКЦИЯ ТЕГОВ ===
    match /tags/{tagId} {
      // Чтение тегов доступно всем
      allow read: if true;
      
      // Управление тегами только для администраторов
      allow write: if isAdmin();
    }
    
    // === ПОДКОЛЛЕКЦИИ ПОЛЬЗОВАТЕЛЕЙ ===
    match /users/{userId}/favorites/{favoriteId} {
      // Пользователь может управлять только своими избранными
      allow read, write: if isOwner(userId);
    }
    
    match /users/{userId}/enrollments/{enrollmentId} {
      // Пользователь может управлять только своими записями на курсы
      allow read, write: if isOwner(userId);
      
      // Администраторы могут просматривать все записи
      allow read: if isAdmin();
    }
    
    // === ЗАПРЕТ ДОСТУПА КО ВСЕМ ОСТАЛЬНЫМ ДОКУМЕНТАМ ===
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
